<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Metrics - AgentAI</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/metrics.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Performance Metrics</h1>
            <nav>
                <a href="/">Dashboard</a>
                <a href="/metrics" class="active">Metrics</a>
            </nav>
        </header>

        <div class="metrics-grid">
            <div class="metric-card">
                <h3>System Resources</h3>
                <canvas id="systemChart"></canvas>
            </div>
            
            <div class="metric-card">
                <h3>LLM Performance</h3>
                <canvas id="llmChart"></canvas>
            </div>
            
            <div class="metric-card">
                <h3>Workflow Duration</h3>
                <canvas id="workflowChart"></canvas>
            </div>
            
            <div class="metric-card">
                <h3>Token Usage</h3>
                <canvas id="tokenChart"></canvas>
            </div>
        </div>

        <div class="stats-summary">
            <div class="stat-item">
                <span class="stat-label">Total Projects</span>
                <span class="stat-value" id="totalProjects">-</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Avg Response Time</span>
                <span class="stat-value" id="avgResponseTime">-</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Success Rate</span>
                <span class="stat-value" id="successRate">-</span>
            </div>
        </div>
    </div>

    <script>
        let charts = {};
        
        async function loadMetrics() {
            try {
                const response = await fetch('/api/metrics');
                const data = await response.json();
                updateCharts(data);
                updateStats(data);
            } catch (error) {
                console.error('Failed to load metrics:', error);
            }
        }

        function updateCharts(data) {
            const timestamps = data.system_metrics?.map(m => new Date(m.timestamp).toLocaleTimeString()) || [];
            
            // System Resources Chart
            updateChart('systemChart', {
                labels: timestamps,
                datasets: [{
                    label: 'CPU %',
                    data: data.system_metrics?.map(m => m.cpu_percent) || [],
                    borderColor: '#007bff',
                    tension: 0.1
                }, {
                    label: 'Memory %',
                    data: data.system_metrics?.map(m => m.memory_percent) || [],
                    borderColor: '#28a745',
                    tension: 0.1
                }]
            });

            // LLM Performance Chart
            updateChart('llmChart', {
                labels: timestamps.slice(-10),
                datasets: [{
                    label: 'Response Time (s)',
                    data: data.llm_metrics?.slice(-10).map(m => m.response_time) || [],
                    borderColor: '#ffc107',
                    tension: 0.1
                }]
            });

            // Workflow Duration Chart
            const workflowLabels = data.workflow_metrics?.map(m => m.phase) || [];
            updateChart('workflowChart', {
                labels: workflowLabels,
                datasets: [{
                    label: 'Duration (s)',
                    data: data.workflow_metrics?.map(m => m.duration) || [],
                    backgroundColor: '#17a2b8',
                }]
            }, 'bar');

            // Token Usage Chart
            updateChart('tokenChart', {
                labels: data.llm_metrics?.slice(-10).map((_, i) => `Call ${i+1}`) || [],
                datasets: [{
                    label: 'Input Tokens',
                    data: data.llm_metrics?.slice(-10).map(m => m.input_tokens) || [],
                    backgroundColor: '#6f42c1',
                }, {
                    label: 'Output Tokens',
                    data: data.llm_metrics?.slice(-10).map(m => m.output_tokens) || [],
                    backgroundColor: '#e83e8c',
                }]
            }, 'bar');
        }

        function updateChart(canvasId, chartData, type = 'line') {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }
            
            charts[canvasId] = new Chart(ctx, {
                type: type,
                data: chartData,
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function updateStats(data) {
            document.getElementById('totalProjects').textContent = data.workflow_metrics?.length || 0;
            
            const avgTime = data.llm_metrics?.length > 0 
                ? (data.llm_metrics.reduce((sum, m) => sum + m.response_time, 0) / data.llm_metrics.length).toFixed(2)
                : '0';
            document.getElementById('avgResponseTime').textContent = avgTime + 's';
            
            const successCount = data.workflow_metrics?.filter(m => m.status === 'completed').length || 0;
            const totalCount = data.workflow_metrics?.length || 1;
            document.getElementById('successRate').textContent = Math.round((successCount / totalCount) * 100) + '%';
        }

        // Load metrics on page load and refresh every 30 seconds
        loadMetrics();
        setInterval(loadMetrics, 30000);
    </script>
</body>
</html>